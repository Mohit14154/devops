name: Backup and Upload


on:
    push:
        branches:
          - 'dev-master'

jobs:
  backup-upload:
    runs-on: self-hosted  # Use your self-hosted EC2 Linux instance

    steps:
    - name: Remove Old Data from Runner
      run: |
        echo "Removing old data from the runner..."
        # Navigate to the workspace directory
        cd $GITHUB_WORKSPACE
        # Remove all files and directories
        rm -rf *
        echo "Old data removed."
        
    - name: Check if PR was merged
      if: github.event.pull_request.merged == true
      run: echo "Pull request was merged."

    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up AWS CLI
      run: |
        sudo yum update -y
        sudo yum install -y awscli
        # IAM roles attached to EC2 instance will automatically provide necessary credentials

    - name: Backup AWS code build folder
      run: |
          echo "Backing up AWS code build folder..."
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          aws s3 mv s3://aws-mohit-data-enginnering/code_build/devops/ s3://aws-mohit-data-enginnering/code_build_bkp/devops_$TIMESTAMP/ --recursive --region ap-south-1

    - name: Sync to S3
      run: |
          echo "Syncing to S3..."
          aws s3 sync /home/ec2-user/actions-runner/_work/devops/ s3://aws-mohit-data-enginnering/code_build/ --delete
